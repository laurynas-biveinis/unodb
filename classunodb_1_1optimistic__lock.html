<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UnoDB: unodb::optimistic_lock Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">UnoDB
   </div>
   <div id="projectbrief">Adaptive Radix Tree in C++, optionally with Optimistic Lock Coupling</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('classunodb_1_1optimistic__lock.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pri-methods">Private Member Functions</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="classunodb_1_1optimistic__lock-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">unodb::optimistic_lock Class Reference<span class="mlabels"><span class="mlabel">final</span></span></div></div>
</div><!--header-->
<div class="contents">

<p>A version-based optimistic lock that supports single-writer/multiple-readers concurrency without shared memory writes during read operations.  
 <a href="classunodb_1_1optimistic__lock.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="optimistic__lock_8hpp_source.html">optimistic_lock.hpp</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classunodb_1_1optimistic__lock_1_1atomic__version__type.html">atomic_version_type</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The atomic lock word and its operations.  <a href="classunodb_1_1optimistic__lock_1_1atomic__version__type.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classunodb_1_1optimistic__lock_1_1read__critical__section.html">read_critical_section</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A read critical section (RCS) that stores the lock version at the read lock time and checks it against the current version for consistent reads.  <a href="classunodb_1_1optimistic__lock_1_1read__critical__section.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classunodb_1_1optimistic__lock_1_1version__type.html">version_type</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Non-atomic lock word representation.  <a href="classunodb_1_1optimistic__lock_1_1version__type.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classunodb_1_1optimistic__lock_1_1write__guard.html">write_guard</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A write guard (WG) for exclusive access protection.  <a href="classunodb_1_1optimistic__lock_1_1write__guard.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a227ade2bbd8cbd17940a7639100fd4d8" id="r_a227ade2bbd8cbd17940a7639100fd4d8"><td class="memItemLeft" align="right" valign="top"><a id="a227ade2bbd8cbd17940a7639100fd4d8" name="a227ade2bbd8cbd17940a7639100fd4d8"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>optimistic_lock</b> (<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="classunodb_1_1optimistic__lock.html">optimistic_lock</a> &amp;)=<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">delete</a></td></tr>
<tr class="separator:a227ade2bbd8cbd17940a7639100fd4d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6cb58fc7c520e311a6448f639353a2cd" id="r_a6cb58fc7c520e311a6448f639353a2cd"><td class="memItemLeft" align="right" valign="top"><a id="a6cb58fc7c520e311a6448f639353a2cd" name="a6cb58fc7c520e311a6448f639353a2cd"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>optimistic_lock</b> (<a class="el" href="classunodb_1_1optimistic__lock.html">optimistic_lock</a> &amp;&amp;)=<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">delete</a></td></tr>
<tr class="separator:a6cb58fc7c520e311a6448f639353a2cd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a56c77c92071c6b0ffab994d7f48170b1" id="r_a56c77c92071c6b0ffab994d7f48170b1"><td class="memItemLeft" align="right" valign="top"><a id="a56c77c92071c6b0ffab994d7f48170b1" name="a56c77c92071c6b0ffab994d7f48170b1"></a>
<a class="el" href="classunodb_1_1optimistic__lock.html">optimistic_lock</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>operator=</b> (<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="classunodb_1_1optimistic__lock.html">optimistic_lock</a> &amp;)=<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">delete</a></td></tr>
<tr class="separator:a56c77c92071c6b0ffab994d7f48170b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b819adb781fe2f733fc7b81f783e024" id="r_a6b819adb781fe2f733fc7b81f783e024"><td class="memItemLeft" align="right" valign="top"><a id="a6b819adb781fe2f733fc7b81f783e024" name="a6b819adb781fe2f733fc7b81f783e024"></a>
<a class="el" href="classunodb_1_1optimistic__lock.html">optimistic_lock</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>operator=</b> (<a class="el" href="classunodb_1_1optimistic__lock.html">optimistic_lock</a> &amp;&amp;)=<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">delete</a></td></tr>
<tr class="separator:a6b819adb781fe2f733fc7b81f783e024"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a557b207dfd8a0d42a63e27dd34a05db0" id="r_a557b207dfd8a0d42a63e27dd34a05db0"><td class="memItemLeft" align="right" valign="top"><a id="a557b207dfd8a0d42a63e27dd34a05db0" name="a557b207dfd8a0d42a63e27dd34a05db0"></a>
<a class="el" href="classunodb_1_1optimistic__lock_1_1read__critical__section.html">read_critical_section</a>&#160;</td><td class="memItemRight" valign="bottom"><b>try_read_lock</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a557b207dfd8a0d42a63e27dd34a05db0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d3bc8fc5293073acb7f1dc9b8f7080a" id="r_a3d3bc8fc5293073acb7f1dc9b8f7080a"><td class="memItemLeft" align="right" valign="top"><a id="a3d3bc8fc5293073acb7f1dc9b8f7080a" name="a3d3bc8fc5293073acb7f1dc9b8f7080a"></a>
<a class="el" href="classunodb_1_1optimistic__lock_1_1read__critical__section.html">read_critical_section</a>&#160;</td><td class="memItemRight" valign="bottom"><b>rehydrate_read_lock</b> (<a class="el" href="namespaceunodb.html#a70595f75a79bde2520bdcfb07689da7b">version_tag_type</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">version_tag</a>) <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a3d3bc8fc5293073acb7f1dc9b8f7080a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0801000a72aa582f32a7d8b3626ff7fd" id="r_a0801000a72aa582f32a7d8b3626ff7fd"><td class="memItemLeft" align="right" valign="top"><a id="a0801000a72aa582f32a7d8b3626ff7fd" name="a0801000a72aa582f32a7d8b3626ff7fd"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">void</a>&#160;</td><td class="memItemRight" valign="bottom"><b>check_on_dealloc</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a0801000a72aa582f32a7d8b3626ff7fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a246e73602241135f01d74ff879f369e9" id="r_a246e73602241135f01d74ff879f369e9"><td class="memItemLeft" align="right" valign="top"><a id="a246e73602241135f01d74ff879f369e9" name="a246e73602241135f01d74ff879f369e9"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><b>is_obsoleted_by_this_thread</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a246e73602241135f01d74ff879f369e9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9696be3421cb1dd27566cfb352d870c" id="r_ad9696be3421cb1dd27566cfb352d870c"><td class="memItemLeft" align="right" valign="top"><a id="ad9696be3421cb1dd27566cfb352d870c" name="ad9696be3421cb1dd27566cfb352d870c"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><b>is_write_locked</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:ad9696be3421cb1dd27566cfb352d870c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a26ddceb8b35d6632bfd6192e01542dd6" id="r_a26ddceb8b35d6632bfd6192e01542dd6"><td class="memItemLeft" align="right" valign="top"><a id="a26ddceb8b35d6632bfd6192e01542dd6" name="a26ddceb8b35d6632bfd6192e01542dd6"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">void</a>&#160;</td><td class="memItemRight" valign="bottom"><b>dump</b> (std::ostream &amp;<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">os</a>) <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a></td></tr>
<tr class="separator:a26ddceb8b35d6632bfd6192e01542dd6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-methods" name="pri-methods"></a>
Private Member Functions</h2></td></tr>
<tr class="memitem:a87019ebcc11a4033acddd2b810adb490" id="r_a87019ebcc11a4033acddd2b810adb490"><td class="memItemLeft" align="right" valign="top"><a id="a87019ebcc11a4033acddd2b810adb490" name="a87019ebcc11a4033acddd2b810adb490"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><b>check</b> (<a class="el" href="classunodb_1_1optimistic__lock_1_1version__type.html">version_type</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">locked_version</a>) <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a87019ebcc11a4033acddd2b810adb490"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a427d68606712d24c073e8f2c13264f55" id="r_a427d68606712d24c073e8f2c13264f55"><td class="memItemLeft" align="right" valign="top"><a id="a427d68606712d24c073e8f2c13264f55" name="a427d68606712d24c073e8f2c13264f55"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><b>try_read_unlock</b> (<a class="el" href="classunodb_1_1optimistic__lock_1_1version__type.html">version_type</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">locked_version</a>) <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a427d68606712d24c073e8f2c13264f55"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a462a9f65f786f790dbbc1b8af92a9e37" id="r_a462a9f65f786f790dbbc1b8af92a9e37"><td class="memItemLeft" align="right" valign="top"><a id="a462a9f65f786f790dbbc1b8af92a9e37" name="a462a9f65f786f790dbbc1b8af92a9e37"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">bool</a>&#160;</td><td class="memItemRight" valign="bottom"><b>try_upgrade_to_write_lock</b> (<a class="el" href="classunodb_1_1optimistic__lock_1_1version__type.html">version_type</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">locked_version</a>) <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a462a9f65f786f790dbbc1b8af92a9e37"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0f579be6e903ef98b1fa9a3122ee636b" id="r_a0f579be6e903ef98b1fa9a3122ee636b"><td class="memItemLeft" align="right" valign="top"><a id="a0f579be6e903ef98b1fa9a3122ee636b" name="a0f579be6e903ef98b1fa9a3122ee636b"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">void</a>&#160;</td><td class="memItemRight" valign="bottom"><b>write_unlock</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a0f579be6e903ef98b1fa9a3122ee636b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af296d16c2c9b99751a0c514149761241" id="r_af296d16c2c9b99751a0c514149761241"><td class="memItemLeft" align="right" valign="top"><a id="af296d16c2c9b99751a0c514149761241" name="af296d16c2c9b99751a0c514149761241"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">void</a>&#160;</td><td class="memItemRight" valign="bottom"><b>write_unlock_and_obsolete</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:af296d16c2c9b99751a0c514149761241"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5f037a7201745546fb1a1530280a166f" id="r_a5f037a7201745546fb1a1530280a166f"><td class="memItemLeft" align="right" valign="top"><a id="a5f037a7201745546fb1a1530280a166f" name="a5f037a7201745546fb1a1530280a166f"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">void</a>&#160;</td><td class="memItemRight" valign="bottom"><b>inc_read_lock_count</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a5f037a7201745546fb1a1530280a166f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a089b1cee3747f7a42618fca56db4b03b" id="r_a089b1cee3747f7a42618fca56db4b03b"><td class="memItemLeft" align="right" valign="top"><a id="a089b1cee3747f7a42618fca56db4b03b" name="a089b1cee3747f7a42618fca56db4b03b"></a>
<a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">void</a>&#160;</td><td class="memItemRight" valign="bottom"><b>dec_read_lock_count</b> () <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">const</a> <a class="el" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">noexcept</a></td></tr>
<tr class="separator:a089b1cee3747f7a42618fca56db4b03b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-attribs" name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:a87ca3251940e5e31314d2a59e760cb7e" id="r_a87ca3251940e5e31314d2a59e760cb7e"><td class="memItemLeft" align="right" valign="top"><a id="a87ca3251940e5e31314d2a59e760cb7e" name="a87ca3251940e5e31314d2a59e760cb7e"></a>
<a class="el" href="classunodb_1_1optimistic__lock_1_1atomic__version__type.html">atomic_version_type</a>&#160;</td><td class="memItemRight" valign="bottom"><b>version</b> {}</td></tr>
<tr class="separator:a87ca3251940e5e31314d2a59e760cb7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a533b7c85785d3da0427152ec1312d6ac" id="r_a533b7c85785d3da0427152ec1312d6ac"><td class="memItemLeft" align="right" valign="top"><a id="a533b7c85785d3da0427152ec1312d6ac" name="a533b7c85785d3da0427152ec1312d6ac"></a>
std::atomic&lt; std::int64_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>read_lock_count</b> {0}</td></tr>
<tr class="separator:a533b7c85785d3da0427152ec1312d6ac"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7feae095aa3b9f62d93da82d4ce6909e" id="r_a7feae095aa3b9f62d93da82d4ce6909e"><td class="memItemLeft" align="right" valign="top"><a id="a7feae095aa3b9f62d93da82d4ce6909e" name="a7feae095aa3b9f62d93da82d4ce6909e"></a>
std::thread::id&#160;</td><td class="memItemRight" valign="bottom"><b>obsoleter_thread</b> {}</td></tr>
<tr class="separator:a7feae095aa3b9f62d93da82d4ce6909e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>A version-based optimistic lock that supports single-writer/multiple-readers concurrency without shared memory writes during read operations. </p>
<p>Writers bump the version counter and readers detect concurrent writes by comparing the version counter before and after the reads.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Examples</h2>
<p>The simplest read locking example: </p><div class="fragment"><div class="line"><span class="comment">// Spin until lock is not write-locked nor obsolete</span></div>
<div class="line"><span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_read_critical_section</a> = lock.try_read_lock();</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_read_critical_section</a>.must_restart()) {</div>
<div class="line">  <span class="comment">// Obsolete, restart</span></div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">// Read</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">read_foo</a> = <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo</a>.data;</div>
<div class="line"><span class="comment">// Try unlock</span></div>
<div class="line"><span class="keywordflow">if</span> (!<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_read_critical_section</a>.try_read_unlock()) {</div>
<div class="line">   <span class="comment">// The lock was write-locked while we were accessing data. Do not act on</span></div>
<div class="line">   <span class="comment">// the read data, restart.</span></div>
<div class="line">   <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">// Act on read_foo and return success</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="ttc" id="anamespaceunodb_html_af9b052db17b88851bb075efd8d84f8d1"><div class="ttname"><a href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">unodb::as_i</a></div><div class="ttdeci">constexpr auto as_i</div><div class="ttdoc">Convert NodeType to a value suitable for use as an index.</div><div class="ttdef"><b>Definition</b> node_type.hpp:81</div></div>
</div><!-- fragment --><p>An example of read locking with interim checks: </p><div class="fragment"><div class="line"><span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a> = lock.try_read_lock();</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a>.must_restart()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">read_foo_1</a> = <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo</a>.data_1;</div>
<div class="line"><span class="comment">// Check whether read_foo_1 was read consistently but do not end the read</span></div>
<div class="line"><span class="comment">// critical section</span></div>
<div class="line"><span class="keywordflow">if</span> (!<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a>.check()) {</div>
<div class="line">  <span class="comment">// The check failed because the lock was write-locked while we were</span></div>
<div class="line">  <span class="comment">// accessing data. Do not act on it, restart.</span></div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">// Act on read_foo_1</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">read_foo_2</a> = <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo</a>.data_2;</div>
<div class="line"><span class="keywordflow">if</span> (!<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a>.try_read_unlock()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="comment">// Both read_foo_1 and read_foo_2 were read consistently together, act on</span></div>
<div class="line"><span class="comment">// them.</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
</div><!-- fragment --><p>An example of write locking: </p><div class="fragment"><div class="line"><span class="comment">// Write lock critical sections always start out as read lock ones.</span></div>
<div class="line"><span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a> = lock.try_read_lock();</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a>.must_restart()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="comment">// Read current data state if needed</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="comment">// Try upgrading the lock</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_write_guard</a> =</div>
<div class="line">  <a class="code hl_class" href="classunodb_1_1optimistic__lock_1_1write__guard.html">optimistic_lock::write_guard</a>{std::move(<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a>)};</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_write_guard</a>.must_restart()) {</div>
<div class="line">  <span class="comment">// The lock upgrade failed because somebody else write-locked it</span></div>
<div class="line">  <span class="comment">// first. Restart, also don&#39;t act on the read data in the read critical</span></div>
<div class="line">  <span class="comment">// section since the last check.</span></div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="line"><span class="comment">// We have the exclusive write lock, freely write the data. The lock will be</span></div>
<div class="line"><span class="comment">// released on scope exit.</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="ttc" id="aclassunodb_1_1optimistic__lock_1_1write__guard_html"><div class="ttname"><a href="classunodb_1_1optimistic__lock_1_1write__guard.html">unodb::optimistic_lock::write_guard</a></div><div class="ttdoc">A write guard (WG) for exclusive access protection.</div><div class="ttdef"><b>Definition</b> optimistic_lock.hpp:539</div></div>
</div><!-- fragment --><p>An example of write locking that ends with data deletion: </p><div class="fragment"><div class="line"><span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a> = lock.try_read_lock();</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a>.must_restart()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="keyword">auto</span> <a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_wg</a> = <a class="code hl_class" href="classunodb_1_1optimistic__lock_1_1write__guard.html">optimistic_lock::write_guard</a>{std::move(<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_rcs</a>)};</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_wg</a>.must_restart()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="comment">// Act on write-locked data before marking it for deletion</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><a class="code hl_variable" href="namespaceunodb.html#af9b052db17b88851bb075efd8d84f8d1">foo_wg</a>.<a class="code hl_function" href="classunodb_1_1optimistic__lock_1_1write__guard.html#a4083c784a45907e08d1b159b30af6bdb">unlock_and_obsolete</a>();</div>
<div class="line"><span class="comment">// Mark data to be reclaimed when it is safe to do so</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="ttc" id="aclassunodb_1_1optimistic__lock_1_1write__guard_html_a4083c784a45907e08d1b159b30af6bdb"><div class="ttname"><a href="classunodb_1_1optimistic__lock_1_1write__guard.html#a4083c784a45907e08d1b159b30af6bdb">unodb::optimistic_lock::write_guard::unlock_and_obsolete</a></div><div class="ttdeci">void unlock_and_obsolete() noexcept</div><div class="ttdoc">Write unlock and make obsolete the underlying lock, deactivating this write guard.</div><div class="ttdef"><b>Definition</b> optimistic_lock.hpp:573</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md14"></a>
API conventions</h2>
<p>All <code>bool</code>-returning <code>try_</code> methods return true on success and false when a concurrent write lock requires the operation to be restarted.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Read protocol</h2>
<p>A read critical section (RCS) is created by unodb::optimistic_lock::try_read_lock(), which will either spin until the lock is not write-locked, or will return immediately if the lock goes to the obsolete state.</p>
<p>The obsolete state must be checked for by calling <a class="el" href="classunodb_1_1optimistic__lock_1_1read__critical__section.html#ab3a83aa11980b8c28b3fdaafe7877160" title="Check whether this RCS was not constructed on an obsolete lock, must be called first thing after crea...">unodb::optimistic_lock::read_critical_section::must_restart()</a> immediately after creating the RCS.</p>
<p>No pointers may be dereferenced in an RCS before a successful read unlock (unodb::optimistic_lock::try_read_unlock()) or an interim check (unodb::optimistic_lock::check()) call. Similarly, no non-pointer data may be accessed in any fault-causing way if it's illegal.</p>
<p>To follow the above rules, first copy the data of interest, then verify consistency via unlock or version check call. Only use the copied data if these operations succeeded. Otherwise an algorithm restart is necessary.</p>
<p>In the current implementation, it is possible for a reader to be starved indefinitely.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Write protocol</h2>
<p>After a successful write lock acquisition by <a class="el" href="classunodb_1_1optimistic__lock_1_1write__guard.html" title="A write guard (WG) for exclusive access protection.">unodb::optimistic_lock::write_guard()</a>, the protected data may be accessed freely, as if under a regular write lock, with the exception of data deletion, discussed below. The write lock object is a C++ scope guard which will unlock on leaving the scope.</p>
<p>Since read locking does not write to the shared memory, readers can have active pointers to the data without the writer knowing about them. Therefore, lock-protected heap data cannot be deallocated immediately. Instead of immediate deallocation, the data is marked as obsolete (unodb::optimistic_lock::write_guard::write_unlock_and_obsolete) and reclaimed later when it is safe to do so. This is implemented by <a class="el" href="group__qsbr.html">Quiescent State-Based Reclamation</a>.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Internals</h2>
<p>A lock is a single machine word, that encodes locked-unlocked state, obsolete state, and version number.</p>
<p>Locking for write (<a class="el" href="classunodb_1_1optimistic__lock_1_1write__guard.html" title="A write guard (WG) for exclusive access protection.">unodb::optimistic_lock::write_guard()</a>) atomically sets the locked state and bumps the version number.</p>
<p>Locking for read (unodb::optimistic_lock::try_read_lock()) saves the version number at the time, and unlocking for read (<a class="el" href="classunodb_1_1optimistic__lock_1_1read__critical__section.html#a440405f82d354281cf33f37de0433b95" title="Check one last time whether this RCS is still valid and unlock it.">unodb::optimistic_lock::read_critical_section::try_read_unlock()</a>) checks whether the lock version did not advance since the read lock. It is also possible to check this in a middle of an RCS (<a class="el" href="classunodb_1_1optimistic__lock_1_1read__critical__section.html#ad027fbe6045c80c4869e6e6d05af408e" title="Check whether this RCS is still valid.">unodb::optimistic_lock::read_critical_section::check()</a>), which has exactly the same semantics under a different name for descriptive code.</p>
<p>A lock in obsolete state marks data which is on the deallocation backlog to be freed once all the thread epochs have advanced. All algorithms must immediately stop retrying read locking such data and restart.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
Literature</h2>
<p>Based on the design from:</p><ul>
<li>V. Leis et al., "The ART of Practical Synchronization," DaMoN 2016, for the algorithms.</li>
<li>H. Boehm, "Can seqlocks get along with programming language memory
  models?", MSPC 2012, for the critical section data access memory ordering rules.</li>
</ul>
<p>The optimistic lock is also similar to Linux kernel sequential locks with the addition of an obsolete state for data marked for reclamation. </p>
</div><hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="optimistic__lock_8hpp_source.html">optimistic_lock.hpp</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespaceunodb.html">unodb</a></li><li class="navelem"><a class="el" href="classunodb_1_1optimistic__lock.html">optimistic_lock</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
