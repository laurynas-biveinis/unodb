<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UnoDB: CONTRIBUTING</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">UnoDB
   </div>
   <div id="projectbrief">Adaptive Radix Tree in C++, optionally with Optimistic Lock Coupling</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_CONTRIBUTING.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">CONTRIBUTING</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md0"></a>
Contributing to UnoDB</h1>
<h2><a class="anchor" id="autotoc_md1"></a>
Optional development dependencies</h2>
<ul>
<li>clang-format</li>
<li>lcov</li>
<li>clang-tidy</li>
<li>clangd</li>
<li>cppcheck</li>
<li>cpplint</li>
<li>include-what-you-use</li>
<li>libfuzzer</li>
</ul>
<h2><a class="anchor" id="autotoc_md2"></a>
General workflow</h2>
<p>Clone the repository, create your feature or fix branches, work on them, commit, open a pull request to this repository.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Development CMake options</h2>
<p>The regular CMake option <code>-DCMAKE_BUILD_TYPE</code> is recognized. Setting it to <code>Debug</code> will enable a lot of assertions, which are useful during development.</p>
<p>There also other development-specific options. All of them are <code>OFF</code> by default.</p>
<ul>
<li><code>-DSTANDALONE=ON</code> always should be given when working on UnoDB itself, whereas for users with UnoDB as a part of another project it should be <code>OFF</code>. When turned on, it will enable extra global debug checks that require entire programs to be compiled with them. Currently, this consists of the libstdc++ debug mode.</li>
<li><code>-DMAINTAINER_MODE=ON</code> to enable maintainer diagnostics. This makes compilation warnings fatal.</li>
<li><code>-DSANITIZE_ADDRESS=ON</code> to enable AddressSanitizer and, if available, LeakSanitizer. It is incompatible with the <code>-DSANITIZE_THREAD=ON</code> option.</li>
<li><code>-DSANITIZE_THREAD=ON</code> to enable ThreadSanitizer. It is incompatible with the <code>-DSANITIZE_ADDRESS=ON</code> option, not available under MSVC, and will disable libfuzzer support if it would be enabled otherwise.</li>
<li><code>-DSANITIZE_UB=ON</code> to enable UndefinedBehaviorSanitizer. It is compatible with other sanitizer options, although some <a href="https://github.com/google/sanitizers/issues/1106">false positive</a> might occur. Not available under MSVC.</li>
<li><code>-DSTATIC_ANALYSIS=ON</code> for GCC or MSVC compiler static analysis. LLVM analyzer is used without any CMake option, see the "Linting and static analysis" section below.</li>
<li><code>-DIWYU=ON</code> to use include-what-you-use. It will take effect if building with clang.</li>
<li><code>-DCPPCHECK_AGGRESSIVE=ON</code> to enable inconclusive cppcheck diagnostics. They will not fail a build.</li>
<li><code>-DCOVERAGE=ON</code> to generate coverage reports on tests, excluding fuzzers, using lcov.</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Code organization</h2>
<p>Header files can be public and internal. The internal ones have "internal" somewhere in their name.</p>
<p>Public API must be introduced in <code>unodb</code> namespace, and any such declarations should appear in a public header. It is OK for the implementation of a public declaration to be in a private header, but see below. All the private declarations for implementation details should live in <code><a class="el" href="namespaceunodb_1_1detail.html" title="The namespace for the UnoDB internal implementation details.">unodb::detail</a></code> namespace. Thus, private headers may contain both <code>unodb</code> and <code><a class="el" href="namespaceunodb_1_1detail.html" title="The namespace for the UnoDB internal implementation details.">unodb::detail</a></code> code, but rethink the header split if the former becomes a majority in a header.</p>
<p>Macros should not be a part of public API, and may be used internally only when unavoidable. If a macro has to be introduced, its name must be prefixed with <code>UNODB_DETAIL_</code>.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Code style guide</h2>
<ul>
<li>The code should follow existing conventions, formatted with <a href="https://google.github.io/styleguide/cppguide.html" title="Google C++ Style Guide">Google C++ style</a>. This is enforced by GitHub Actions SuperLinter running clang-format, currently version 17.</li>
<li>Each source file must have a <code>// Copyright &lt;file-intro-year&gt;-&lt;last-edit-year&gt; UnoDB contributors</code> as the first line.</li>
<li>Each source file must <code>#include "global.hpp"</code> first thing.</li>
<li>Identifiers should be <code>snake_case</code>.</li>
<li>Type names should either have no suffix, or <code>_type</code> when declaring types from template parameters and other identifiers. It cannot be <code>_t</code> as this suffix is reserved by POSIX.</li>
<li>The code is <code>noexcept</code>-maximalist. Every function and method that cannot throw should be marked as <code>noexcept</code>. If the code does not throw in release build but may throw in debug one, it should ignore the latter and be <code>noexcept</code>.</li>
<li>The code is exception-safe, with strong exception guarantee. This is actually tested by <a href="test/test_art_oom.cpp">test/test_art_oom.cpp</a> injecting <code>std::bad_alloc</code> into heap allocations. New code should exception-safe too, with OOM tests expanded as necessary.</li>
<li>The code is <code>[[nodiscard]]</code>-maximalist. Every value-returning function and method starts out as <code>[[nodiscard]]</code> by default, and is only changed if there is a clear need to both handle and ignore the return value.</li>
<li>The code follows the Almost Always Auto guideline.</li>
<li><code>const</code> should be used everywhere it is possible to do so, with the exception of by-value function parameters and class fields that support moving from.</li>
<li><code>constexpr</code> should be applied everywhere it is legal to do so. Perhaps one day we will have compile-time Adaptive Radix Tree.</li>
<li>All C++ standard library symbols must be namespace-qualified, and this includes symbols shared with C. For example <code>std::size_t</code>.</li>
<li>Automatic code formatting can be configured through git clean/fuzz filters. To enable this feature, do <code>git config --local include.path ../.gitconfig</code>. If you need to temporarily disable it, run <code>git config --local --unset include.path</code>.</li>
<li>The code that cannot be possibly tested by short deterministic tests, for example, because it handles rarely-occurring non-deterministic concurrency conditions, should be excluded from coverage testing with <code>// LCOV_EXCL_LINE</code> comment for a single line or with <code>// LCOV_EXCL_START</code>, <code>// LCOV_EXCL_STOP</code> start and end markers for a block.</li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
Documentation style guide</h2>
<ul>
<li>The code should be commented, but without comments repeating already obvious code.</li>
<li><code>TODO</code> comments may be used for future tasks. <code>FIXME</code> comments should be used for things that must be fixed before the code lands in the master branch, however sometimes they land there. In both cases they should have a username in parentheses, i.e. <code>TODO(alice)</code>, <code>FIXME(bob)</code>. It indicates the comment author, not necessarily who should address it.</li>
<li>Doxygen is used to produce source code documentation.</li>
<li>Doxygen commands should use <code>\foo</code> (and not <code>@foo</code>) syntax.</li>
<li>The preferred location of the comments is next to the declarations. An exception is declarations with multiple conditionally compiled declarations, in which case a Doxygen comment with a <code>\def</code>, <code>\var</code>, or another suitable tag for the declaration should appear at the top of its section or source file, and it should also have a <code>\hideinitializer</code> tag.</li>
<li>Doxygen automatic brief description detection is enabled, thus explicit <code>\brief</code> tags are not required, rather the first sentence in the Doxygen comment block will be interpreted as the brief description.</li>
<li>Markdown markup is preferred, i.e. `<code>foo</code> instead of <code>\c foo</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
Linting and static analysis</h2>
<p>clang-tidy, cppcheck, and cpplint will be invoked automatically during the build if found. The current diagnostic level for them, as well as for compiler warnings, is set very high and can be relaxed if needed.</p>
<p>For GCC or MSVC static analysis, add <code>-DSTATIC_ANALYSIS=ON</code> CMake option as listed in the "CMake options" section above. For LLVM, no special CMake option is needed; instead prepend <code>scan-build</code> to <code>make</code>.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Testing</h2>
<p>Google Test and DeepState fuzzer are used for testing. For DeepState, both LLVM libfuzzer and built-in fuzzer are supported.</p>
<p>To run the tests, do <code>ctest</code>. It is also useful to run tests in parallel with e.g. <code>ctest -j10</code>. For verbose test output add <code>-V</code>.</p>
<p>Benchmarks can also serve as tests, especially under debug build and under sanitizers or Valgrind. For that, there is a CMake target <code>quick_benchmarks</code>, i.e. <code>make -j10 -k quick_benchmarks</code>. CI runs this target too.</p>
<p>To run everything (tests and quick benchmarks) under Valgrind, use <code>valgrind</code> CMake target.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Fuzzing</h2>
<p>Fuzzer tests for ART and QSBR components are located in the <code>fuzz_deepstate</code> subdirectory. The tests use DeepState with either a brute force or libfuzzer-based backend. However, the only supported platforms are Linux (GCC &amp; clang) and macOS (clang only, no AddressSanitizer and ThreadSanitizer) under x86_64 only.</p>
<p>Several Make targets are available for fuzzing. For time-based brute-force fuzzing of all components, use one of the following: <code>deepstate_2s</code>, <code>deepstate_1m</code>, <code>deepstate_20m</code>, or <code>deepstate_8h</code>. To use individual fuzzers, insert <code>art</code> or <code>qsbr</code>, for example: <code>deepstate_qsbr_20m</code> or <code>deepstate_art_8h</code>. Running fuzzer under Valgrind is available through <code>valgrind_deepstate</code> for everything or <code>valgrind_{art|qsbr}_deepstate</code> for individual fuzzers.</p>
<p>Fuzzers that use libfuzzer mirror the above by adding <code>_lf</code> before the time suffix, such as <code>deepstate_lf_8h</code>, <code>deepstate_qsbr_lf_20m</code>, <code>valgrind_deepstate_lf</code>, and so on.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Commit messages</h2>
<ul>
<li>Keep the first line under 72 characters and don't finish it with a full stop.</li>
<li>The second line should be empty.</li>
<li>Use imperative mood ("Fix bug" not "fixes bug", nor "fixed bug").</li>
<li>Reference fixed issues, i.e. "fixes: #123"</li>
</ul>
<h2><a class="anchor" id="autotoc_md11"></a>
Pull Requests</h2>
<ul>
<li>Create one PR per feature or fix. If it is possible to split PR into independent smaller parts, do so.</li>
<li>Include documentation updates for the changes, use Doxygen as needed.</li>
<li>Code changes should be covered by small deterministic tests. The coverage target is 100% (to the achievable extent), after non-deterministic code has been annotated to be excluded from coverage as described in the "Style Guide" section above.</li>
<li>A clean CI run is a prerequisite for merging the PR.</li>
<li>In the case of merge conflicts, rebase.</li>
<li>All commits should be squashed into logical units. If the PR has only one feature or fix, as it should, there should be only one commit in it.</li>
<li>Very obvious changes may be pushed directly.</li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
Benchmarking</h2>
<p>Benchmarking is hard: it is easy to do it incorrectly with no obvious warning signs. Here are some suggestions how to set it up. They will not guarantee valid results but should exclude some classes of invalid ones:</p>
<ul>
<li><p class="startli">Set up the benchmark machine for the best CPU counter observability and run repeatability. This configuration is at odds with some of the Linux security features, so don't do that on machines close to production:</p>
<div class="fragment"><div class="line">sudo sh -c &quot;echo -1 &gt; /proc/sys/kernel/perf_event_paranoid&quot;</div>
<div class="line">sudo sysctl -w kernel.kptr_restrict=0</div>
<div class="line">sudo sh -c &quot;echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope&quot;</div>
<div class="line">sudo sysctl -w vm.swappiness=0</div>
</div><!-- fragment --></li>
<li><p class="startli">To make the above settings survive reboots, edit <code>/etc/sysctl.conf</code> for:</p>
<div class="fragment"><div class="line">kernel.perf_event_paranoid = -1</div>
<div class="line">kernel.kptr_restrict = 0</div>
<div class="line">vm.swappiness = 0</div>
</div><!-- fragment --><p class="startli">and <code>/etc/sysctl.d/10-ptrace.conf</code> for <code>kernel.yama.ptrace_scope = 0</code>.</p>
</li>
<li>On x86_64, make sure to use the performance governor for the CPU frequency management: edit <code>/etc/default/cpufrequtils</code> for <code>GOVERNOR="performance"</code> followed by <code>sudo /etc/init.d/cpufrequtils restart</code>. You can also do <code>sudo cpupower frequency-set --governor performance</code> for transient setting.</li>
<li>Disable hyperthreading: <code>sudo sh -c "echo off &gt; /sys/devices/system/cpu/smt/control"</code></li>
<li>Pick a CPU and shield it from other threads running there: <code>sudo cset shield --cpu=2 --kthread=on</code></li>
<li>Start a shell for benchmarking in the shield: <code>sudo cset shield --exec zsh</code></li>
<li>Use jemalloc for heap: <code>export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2</code></li>
<li>Now run your desired benchmarks. For the supported flags for i.e. benchmark filtering see <a href="https://github.com/google/benchmark/blob/main/docs/user_guide.md">Google Benchmark documentation</a>.</li>
<li><p class="startli">To measure the effect of a patch, Google Benchmark provides <a href="https://github.com/google/benchmark/blob/main/docs/tools.md#u-test">U-Test</a> feature. Let's say you changed N16 node fields, but only for the OLC case. Then you can run N16-specific tests, filtered for the OLC. The next command is in the directory with benchmark executables, and the baseline executables are at <code>/foo/bar/baseline</code>:</p>
<div class="fragment"><div class="line">python3 ../../../3rd_party/benchmark/tools/compare.py benchmarks \</div>
<div class="line">   /foo/bar/baseline/micro_benchmark_olc \</div>
<div class="line">   ./micro_benchmark_olc --benchmark_repetitions=9</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
License</h2>
<p>By contributing, you agree that your contributions will be licensed under the [LICENSE](LICENSE) terms. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
